# N+1 ì¿¼ë¦¬ ë¬¸ì œ (N+1 Query Problem)

> ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ì„ ì €í•´í•˜ëŠ” ê°€ì¥ í”í•œ ì•ˆí‹°íŒ¨í„´

## ê°œìš”

**N+1 ì¿¼ë¦¬ ë¬¸ì œ**ëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ 1ê°œì˜ ì´ˆê¸° ì¿¼ë¦¬ ì‹¤í–‰ í›„, Nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë¹„íš¨ìœ¨ì ì¸ ë°ì´í„° ì ‘ê·¼ íŒ¨í„´ì…ë‹ˆë‹¤.

### í•µì‹¬ ì•„ì´ë””ì–´

```
"1ê°œì˜ ì¿¼ë¦¬ë¡œ ì¶©ë¶„í•œ ì‘ì—…ì— N+1ê°œì˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒ"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    N+1 ì¿¼ë¦¬ ë¬¸ì œ ì‹œê°í™”                      â”‚
â”‚                                                             â”‚
â”‚   1ë²ˆ ì¿¼ë¦¬: ëª¨ë“  ì¹´í…Œê³ ë¦¬ ì¡°íšŒ                               â”‚
â”‚       SELECT * FROM categories                              â”‚
â”‚              â†“                                              â”‚
â”‚       [Cat1] [Cat2] [Cat3] ... [CatN]                       â”‚
â”‚         â†“      â†“      â†“          â†“                          â”‚
â”‚       ì¿¼ë¦¬2  ì¿¼ë¦¬3  ì¿¼ë¦¬4  ... ì¿¼ë¦¬N+1                        â”‚
â”‚                                                             â”‚
â”‚   ì´ ì¿¼ë¦¬ ìˆ˜: 1 + N = N+1ê°œ ğŸ˜±                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì™œ ë¬¸ì œì¸ê°€?

### í”í•œ ì˜¤í•´

```
âŒ "ë§ì€ ì‘ì€ ì¿¼ë¦¬ê°€ í•˜ë‚˜ì˜ í° ì¿¼ë¦¬ë³´ë‹¤ íš¨ìœ¨ì ì´ë‹¤"

âœ… ì‹¤ì œë¡œëŠ” ì •ë°˜ëŒ€!
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ê° ì¿¼ë¦¬ë§ˆë‹¤ ë„¤íŠ¸ì›Œí¬ ì™•ë³µ(Round-trip) ë°œìƒ
â€¢ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë²„í—¤ë“œ ëˆ„ì 
â€¢ DB ìµœì í™”(ì¸ë±ìŠ¤, ìºì‹œ ë“±)ë¥¼ ì œëŒ€ë¡œ í™œìš© ëª»í•¨
```

### ì„±ëŠ¥ ì˜í–¥

| ìƒí™© | ì¿¼ë¦¬ ìˆ˜ | ì˜ˆìƒ ì†Œìš” ì‹œê°„ |
|------|---------|----------------|
| N+1 ë°©ì‹ (17ê°œ ì¹´í…Œê³ ë¦¬, 800ê°œ í•­ëª©) | 18ë²ˆ | ~1ì´ˆ ì´ìƒ |
| JOIN ì‚¬ìš© (ë™ì¼ ë°ì´í„°) | 1ë²ˆ | ~0.16ì´ˆ |
| **ì„±ëŠ¥ í–¥ìƒ** | - | **ì•½ 10ë°°** |

---

## êµ¬ì²´ì ì¸ ì˜ˆì‹œ

### í…Œì´ë¸” êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   categories    â”‚       â”‚     items       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ category_id (FK)â”‚
â”‚ name            â”‚       â”‚ id (PK)         â”‚
â”‚ description     â”‚       â”‚ name            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ price           â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ (N+1)

```php
// 1ë²ˆì§¸ ì¿¼ë¦¬: ëª¨ë“  ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
$categories = DB::query("SELECT * FROM categories");

// Në²ˆì˜ ì¶”ê°€ ì¿¼ë¦¬: ê° ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ ì¡°íšŒ
foreach ($categories as $category) {
    // ì´ ì¿¼ë¦¬ê°€ ì¹´í…Œê³ ë¦¬ ìˆ˜ë§Œí¼ ì‹¤í–‰ë¨!
    $items = DB::query(
        "SELECT * FROM items WHERE category_id = ?",
        [$category['id']]
    );

    echo $category['name'] . ": " . count($items) . " items\n";
}
```

### ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë“¤

```sql
-- 1ë²ˆ ì¿¼ë¦¬
SELECT * FROM categories;

-- 2ë²ˆ ì¿¼ë¦¬ (ì¹´í…Œê³ ë¦¬ 1)
SELECT * FROM items WHERE category_id = 1;

-- 3ë²ˆ ì¿¼ë¦¬ (ì¹´í…Œê³ ë¦¬ 2)
SELECT * FROM items WHERE category_id = 2;

-- 4ë²ˆ ì¿¼ë¦¬ (ì¹´í…Œê³ ë¦¬ 3)
SELECT * FROM items WHERE category_id = 3;

-- ... (ê³„ì†)

-- N+1ë²ˆ ì¿¼ë¦¬ (ì¹´í…Œê³ ë¦¬ N)
SELECT * FROM items WHERE category_id = N;
```

---

## í•´ê²° ë°©ë²•

### 1. JOINì„ ì‚¬ìš©í•œ ë‹¨ì¼ ì¿¼ë¦¬

```sql
SELECT
    c.id AS category_id,
    c.name AS category_name,
    i.id AS item_id,
    i.name AS item_name,
    i.price
FROM categories c
LEFT JOIN items i ON c.id = i.category_id
ORDER BY c.name, i.name;
```

```
ê²°ê³¼ ì˜ˆì‹œ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
category_id | category_name | item_id | item_name
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1           | Electronics   | 101     | Phone
1           | Electronics   | 102     | Laptop
2           | Books         | 201     | Novel
2           | Books         | 202     | Textbook
...
```

### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°ì´í„° êµ¬ì¡°í™”

```php
// ë‹¨ì¼ JOIN ì¿¼ë¦¬ ì‹¤í–‰
$results = DB::query("
    SELECT c.id AS category_id, c.name AS category_name,
           i.id AS item_id, i.name AS item_name
    FROM categories c
    LEFT JOIN items i ON c.id = i.category_id
    ORDER BY c.name, i.name
");

// ê²°ê³¼ë¥¼ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
$categories = [];
foreach ($results as $row) {
    $catId = $row['category_id'];

    if (!isset($categories[$catId])) {
        $categories[$catId] = [
            'name' => $row['category_name'],
            'items' => []
        ];
    }

    if ($row['item_id'] !== null) {
        $categories[$catId]['items'][] = [
            'id' => $row['item_id'],
            'name' => $row['item_name']
        ];
    }
}
```

### 3. Eager Loading (ORM ì‚¬ìš© ì‹œ)

```php
// Laravel Eloquent ì˜ˆì‹œ

// âŒ N+1 ë¬¸ì œ ë°œìƒ
$categories = Category::all();
foreach ($categories as $category) {
    echo $category->items->count(); // ê°ê° ì¿¼ë¦¬ ì‹¤í–‰
}

// âœ… Eager Loadingìœ¼ë¡œ í•´ê²°
$categories = Category::with('items')->get();
foreach ($categories as $category) {
    echo $category->items->count(); // ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ
}
```

```javascript
// Prisma (JavaScript/TypeScript) ì˜ˆì‹œ

// âŒ N+1 ë¬¸ì œ ë°œìƒ
const categories = await prisma.category.findMany();
for (const cat of categories) {
    const items = await prisma.item.findMany({
        where: { categoryId: cat.id }
    });
}

// âœ… Includeë¡œ í•´ê²°
const categories = await prisma.category.findMany({
    include: { items: true }
});
```

---

## í•´ê²° ë°©ë²• ë¹„êµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    í•´ê²° ë°©ë²• ë¹„êµ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  ë°©ë²• 1: JOIN ì‚¬ìš©                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚  ì¥ì : ê°€ì¥ íš¨ìœ¨ì , ë‹¨ì¼ ì¿¼ë¦¬                                   â”‚
â”‚  ë‹¨ì : ê²°ê³¼ ë°ì´í„° ì¤‘ë³µ (ì¹´í…Œê³ ë¦¬ ì •ë³´ ë°˜ë³µ)                     â”‚
â”‚                                                                â”‚
â”‚  ë°©ë²• 2: ë‘ ë²ˆì˜ ì¿¼ë¦¬ (IN ì ˆ ì‚¬ìš©)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  SELECT * FROM categories;                                     â”‚
â”‚  SELECT * FROM items WHERE category_id IN (1, 2, 3, ...);      â”‚
â”‚                                                                â”‚
â”‚  ì¥ì : ë°ì´í„° ì¤‘ë³µ ì—†ìŒ, ë©”ëª¨ë¦¬ íš¨ìœ¨ì                           â”‚
â”‚  ë‹¨ì : ë‘ ë²ˆì˜ ì¿¼ë¦¬ í•„ìš”                                        â”‚
â”‚                                                                â”‚
â”‚  ë°©ë²• 3: ORM Eager Loading                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  ì¥ì : ì½”ë“œê°€ ê°„ê²°, ìë™ ìµœì í™”                                 â”‚
â”‚  ë‹¨ì : ORM ì˜ì¡´ì„±, ë‚´ë¶€ ë™ì‘ ì´í•´ í•„ìš”                          â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## N+1 ë¬¸ì œ íƒì§€ ë°©ë²•

### 1. Laravelì—ì„œ ìë™ íƒì§€

```php
// AppServiceProvider.php
use Illuminate\Database\Eloquent\Model;

public function boot()
{
    // í”„ë¡œë•ì…˜ì´ ì•„ë‹ ë•Œ N+1 ê°ì§€ ì‹œ ì˜ˆì™¸ ë°œìƒ
    Model::preventLazyLoading(!app()->isProduction());
}
```

### 2. ì¿¼ë¦¬ ë¡œê¹…ìœ¼ë¡œ í™•ì¸

```php
// Laravel
DB::listen(function ($query) {
    Log::info($query->sql);
    Log::info($query->time . 'ms');
});
```

```javascript
// Prisma
const prisma = new PrismaClient({
    log: ['query', 'info', 'warn', 'error'],
});
```

### 3. ì˜ì‹¬ íŒ¨í„´ ì‹ë³„

```
N+1 ì˜ì‹¬ ì§•í›„:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ ë™ì¼í•œ ì¿¼ë¦¬ê°€ ë°˜ë³µì ìœ¼ë¡œ ì‹¤í–‰ë¨
âœ“ ì½ì€ í–‰ ìˆ˜ >> ë°˜í™˜ëœ í–‰ ìˆ˜
âœ“ ë£¨í”„ ì•ˆì—ì„œ ì¿¼ë¦¬ ì‹¤í–‰
âœ“ í˜ì´ì§€ ë¡œë”©ì´ ë°ì´í„° ì¦ê°€ì— ë¹„ë¡€í•´ ëŠë ¤ì§
```

---

## ë‹¤ì–‘í•œ ìƒí™©ë³„ í•´ê²°ì±…

### GraphQLì—ì„œì˜ N+1

```javascript
// DataLoader ì‚¬ìš©ìœ¼ë¡œ í•´ê²°
const itemLoader = new DataLoader(async (categoryIds) => {
    const items = await db.items.findMany({
        where: { categoryId: { in: categoryIds } }
    });

    // categoryIdë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ë°˜í™˜
    return categoryIds.map(id =>
        items.filter(item => item.categoryId === id)
    );
});

// resolverì—ì„œ ì‚¬ìš©
const resolvers = {
    Category: {
        items: (category) => itemLoader.load(category.id)
    }
};
```

### API ì„¤ê³„ì—ì„œ ê³ ë ¤ì‚¬í•­

```
âŒ í”¼í•´ì•¼ í•  íŒ¨í„´:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET /categories
â†’ ê° ì¹´í…Œê³ ë¦¬ë§ˆë‹¤ GET /categories/{id}/items í˜¸ì¶œ

âœ… ê¶Œì¥í•˜ëŠ” íŒ¨í„´:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET /categories?include=items
â†’ í•œ ë²ˆì˜ ìš”ì²­ìœ¼ë¡œ ëª¨ë“  ë°ì´í„° ë°˜í™˜
```

---

## í•µì‹¬ ì •ë¦¬

1. **N+1 ë¬¸ì œëŠ” ì„±ëŠ¥ì˜ ì **
   - 1ê°œ ì¿¼ë¦¬ë¡œ ì¶©ë¶„í•œ ì‘ì—…ì— N+1ê°œ ì¿¼ë¦¬ ì‹¤í–‰
   - ë„¤íŠ¸ì›Œí¬ ì™•ë³µì´ ëˆ„ì ë˜ì–´ ì‹¬ê°í•œ ì„±ëŠ¥ ì €í•˜

2. **JOIN ë˜ëŠ” Eager Loading ì‚¬ìš©**
   - SQL JOINìœ¼ë¡œ ë‹¨ì¼ ì¿¼ë¦¬ ì‘ì„±
   - ORMì—ì„œëŠ” with(), include() ë“± í™œìš©

3. **ë£¨í”„ ì•ˆì—ì„œ ì¿¼ë¦¬ í”¼í•˜ê¸°**
   - ë°˜ë³µë¬¸ ë‚´ DB í˜¸ì¶œì€ N+1ì˜ ì‹ í˜¸
   - ë¯¸ë¦¬ í•„ìš”í•œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë¡œë“œ

4. **ëª¨ë‹ˆí„°ë§ ë„êµ¬ í™œìš©**
   - ì¿¼ë¦¬ ë¡œê¹…ìœ¼ë¡œ íŒ¨í„´ í™•ì¸
   - ORM ìë™ íƒì§€ ê¸°ëŠ¥ í™œì„±í™”

5. **ì„¤ê³„ ë‹¨ê³„ì—ì„œ ê³ ë ¤**
   - API ì„¤ê³„ ì‹œ ì—°ê´€ ë°ì´í„° í¬í•¨ ì˜µì…˜ ì œê³µ
   - GraphQLì—ì„œëŠ” DataLoader íŒ¨í„´ ì ìš©

---

## ì°¸ê³  ìë£Œ

- [What is the N+1 Query Problem and How to Solve It | PlanetScale](https://planetscale.com/blog/what-is-n-1-query-problem-and-how-to-solve-it)
- [Eager Loading in Laravel | Laravel Documentation](https://laravel.com/docs/eloquent-relationships#eager-loading)
- [DataLoader | GraphQL Best Practices](https://github.com/graphql/dataloader)

---

*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2025-12-21*
