# AWS 보안그룹 vs NACL 완벽 가이드

> 라우팅 테이블이 "경로"라면, 보안그룹/NACL은 "검문소"

## 목차
1. [왜 두 가지 방화벽이 필요한가?](#왜-두-가지-방화벽이-필요한가)
2. [보안그룹 (Security Group) 완벽 이해](#보안그룹-security-group-완벽-이해)
3. [NACL (Network ACL) 완벽 이해](#nacl-network-acl-완벽-이해)
4. [Stateful vs Stateless의 진실](#stateful-vs-stateless의-진실)
5. [실전 시나리오와 설정](#실전-시나리오와-설정)

---

## 왜 두 가지 방화벽이 필요한가?

### 방어의 계층화 (Defense in Depth)

```
인터넷
  │
  ▼
┌─────────────────────────────────────────────────────────────┐
│ Internet Gateway                                            │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│                      VPC (10.0.0.0/16)                      │
│                                                             │
│  ┌────────────────────────────────────────────────────┐    │
│  │          Subnet (10.0.1.0/24)                      │    │
│  │                                                    │    │
│  │  🛡️ 1차 방어: NACL (서브넷 레벨)                   │    │
│  │  ├─ Inbound Rules  (들어오는 트래픽 검사)           │    │
│  │  └─ Outbound Rules (나가는 트래픽 검사)            │    │
│  │       │                                            │    │
│  │       ▼                                            │    │
│  │  ┌──────────────────────────────────────────┐     │    │
│  │  │  🛡️ 2차 방어: Security Group (인스턴스)  │     │    │
│  │  │  ├─ Inbound Rules                        │     │    │
│  │  │  └─ Outbound Rules                       │     │    │
│  │  │       │                                   │     │    │
│  │  │       ▼                                   │     │    │
│  │  │  ┌─────────────────┐                     │     │    │
│  │  │  │   EC2 Instance   │                    │     │    │
│  │  │  │   10.0.1.10     │                     │     │    │
│  │  │  └─────────────────┘                     │     │    │
│  │  └──────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 일상 비유

```
NACL = 아파트 정문 경비 (동 전체 보안)
┌──────────────────────────────────────────────┐
│ "이 아파트에 들어오려면?"                    │
│ • 택배 차량: OK                              │
│ • 의심스러운 차량: 차단                      │
│ • 아파트 전체에 적용되는 규칙                │
└──────────────────────────────────────────────┘

Security Group = 각 집 현관문 (개별 집 보안)
┌──────────────────────────────────────────────┐
│ "우리 집에 들어오려면?"                      │
│ • 가족: OK                                   │
│ • 등록된 친구: OK                            │
│ • 낯선 사람: 차단                            │
│ • 각 집마다 다른 규칙 가능                   │
└──────────────────────────────────────────────┘
```

---

## 보안그룹 (Security Group) 완벽 이해

### 핵심 특징

```
1️⃣ Stateful (상태 유지형)
   - 요청 허용하면 응답은 자동 허용
   - Outbound 규칙 확인 안 함

2️⃣ 인스턴스 레벨 방화벽
   - EC2, RDS, ALB, Lambda(ENI) 등에 적용

3️⃣ Allow 규칙만 존재
   - Deny 규칙 없음 (기본 Deny All)

4️⃣ 규칙 변경 즉시 적용
   - 연결 끊김 없이 실시간 반영

5️⃣ 보안그룹끼리 참조 가능
   - "sg-web만 접속 허용" 같은 설정
```

### Stateful 동작 방식

```
예시: 사용자가 웹서버(80 포트)에 접속

클라이언트 (211.234.123.45:54321) → 서버 (10.0.1.10:80)

┌─────────────────────────────────────────────────────────┐
│                   보안그룹 검사                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📥 Inbound 검사 (들어오는 요청)                        │
│  ┌────────────────────────────────────────────────┐   │
│  │ Type: HTTP                                      │   │
│  │ Protocol: TCP                                   │   │
│  │ Port: 80                                        │   │
│  │ Source: 0.0.0.0/0                              │   │
│  │                                                 │   │
│  │ 211.234.123.45:54321 → 10.0.1.10:80            │   │
│  │ ✅ 허용! (80 포트 열려있음)                     │   │
│  └────────────────────────────────────────────────┘   │
│                                                         │
│  📤 Outbound 검사 (나가는 응답)                         │
│  ┌────────────────────────────────────────────────┐   │
│  │ Stateful이므로 자동 허용! ✅                    │   │
│  │                                                 │   │
│  │ 10.0.1.10:80 → 211.234.123.45:54321            │   │
│  │ (요청을 허용했으니 응답도 자동 허용)            │   │
│  │                                                 │   │
│  │ Outbound 규칙 확인 안 함!                       │   │
│  └────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘

💡 핵심: 연결(Connection) 추적 테이블에 기록됨
   요청이 들어오면 "이 연결의 응답은 허용"으로 자동 설정
```

### 기본 보안그룹 구조

```nginx
# 웹 서버 보안그룹 (sg-web)
Inbound Rules:
┌──────┬──────────┬────────┬─────────────────┬─────────────────┐
│ Type │ Protocol │ Port   │ Source          │ Description     │
├──────┼──────────┼────────┼─────────────────┼─────────────────┤
│ HTTP │ TCP      │ 80     │ 0.0.0.0/0       │ Public access   │
│ HTTPS│ TCP      │ 443    │ 0.0.0.0/0       │ Public SSL      │
│ SSH  │ TCP      │ 22     │ 1.2.3.4/32      │ Admin only      │
└──────┴──────────┴────────┴─────────────────┴─────────────────┘

Outbound Rules:
┌──────┬──────────┬────────┬─────────────────┬─────────────────┐
│ Type │ Protocol │ Port   │ Destination     │ Description     │
├──────┼──────────┼────────┼─────────────────┼─────────────────┤
│ All  │ All      │ All    │ 0.0.0.0/0       │ Allow all out   │
└──────┴──────────┴────────┴─────────────────┴─────────────────┘

# 기본값: Outbound All Traffic 허용
# (Stateful이라 응답 전송용으로 충분)
```

```nginx
# DB 서버 보안그룹 (sg-db)
Inbound Rules:
┌──────────┬──────────┬────────┬─────────────────┬──────────────┐
│ Type     │ Protocol │ Port   │ Source          │ Description  │
├──────────┼──────────┼────────┼─────────────────┼──────────────┤
│ PostgreSQL│ TCP     │ 5432   │ sg-web          │ From web     │
│ PostgreSQL│ TCP     │ 5432   │ sg-bastion      │ From bastion │
└──────────┴──────────┴────────┴─────────────────┴──────────────┘

💡 Source를 보안그룹으로 지정!
   "sg-web이 붙은 모든 인스턴스 허용"
   IP 하드코딩 안 해도 됨!

Outbound Rules:
┌──────┬──────────┬────────┬─────────────────┬─────────────────┐
│ Type │ Protocol │ Port   │ Destination     │ Description     │
├──────┼──────────┼────────┼─────────────────┼─────────────────┤
│ All  │ All      │ All    │ 0.0.0.0/0       │ Allow all out   │
└──────┴──────────┴────────┴─────────────────┴─────────────────┘
```

### 실전 예시: 3-Tier 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                           Internet                          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   ALB (sg-alb)      │
              │   • In: 80,443/Any  │
              │   • Out: All        │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  Web (sg-web)       │
              │  • In: 8080/sg-alb  │ ← sg-alb로부터만!
              │  • Out: All         │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  RDS (sg-db)        │
              │  • In: 5432/sg-web  │ ← sg-web으로부터만!
              │  • Out: None needed │
              └─────────────────────┘

✅ 장점: IP가 바뀌어도 보안그룹 규칙은 그대로!
```

---

## NACL (Network ACL) 완벽 이해

### 핵심 특징

```
1️⃣ Stateless (상태 비추적형)
   - 요청 허용해도 응답은 별도 허용 필요
   - Inbound + Outbound 둘 다 설정

2️⃣ 서브넷 레벨 방화벽
   - 서브넷 전체에 적용
   - 서브넷 내부 통신은 검사 안 함

3️⃣ Allow + Deny 규칙 둘 다 존재
   - 번호 순서대로 평가 (낮은 번호 우선)
   - 매칭되면 즉시 처리 (이후 규칙 무시)

4️⃣ 기본 NACL = 모든 트래픽 허용
   - Custom NACL = 기본 모든 트래픽 차단

5️⃣ Ephemeral Port 고려 필요
   - 응답을 위한 임시 포트 범위 열어야 함
```

### Stateless 동작 방식

```
예시: 사용자가 웹서버(80 포트)에 접속

클라이언트 (211.234.123.45:54321) → 서버 (10.0.1.10:80)

┌─────────────────────────────────────────────────────────┐
│                      NACL 검사                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📥 Inbound 검사 (들어오는 요청)                        │
│  ┌────────────────────────────────────────────────┐   │
│  │ Rule #  Type    Protocol  Port    Source  Allow│   │
│  │ 100     HTTP    TCP       80      0.0.0.0/0  ✅│   │
│  │                                                 │   │
│  │ 211.234.123.45:54321 → 10.0.1.10:80            │   │
│  │ ✅ Rule 100 매칭, 허용                          │   │
│  └────────────────────────────────────────────────┘   │
│                                                         │
│  📤 Outbound 검사 (나가는 응답)                         │
│  ┌────────────────────────────────────────────────┐   │
│  │ ⚠️  Stateless라 별도 검사 필요!                 │   │
│  │                                                 │   │
│  │ Rule #  Type      Protocol  Port       Dest    │   │
│  │ 100     Custom    TCP       1024-65535 0.0.0.0/0│  │
│  │                                                 │   │
│  │ 10.0.1.10:80 → 211.234.123.45:54321            │   │
│  │                      ▲                          │   │
│  │                54321 포트 (Ephemeral Port)      │   │
│  │                                                 │   │
│  │ ✅ Rule 100 매칭 (1024-65535 범위), 허용        │   │
│  └────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘

💡 핵심: 연결 추적 안 함!
   응답도 Outbound 규칙과 매칭되어야 통과
```

### Ephemeral Port란?

```
클라이언트가 서버에 연결할 때 사용하는 임시 포트

예시:
브라우저 → 웹서버 연결 시
┌──────────────────────────────────────────────┐
│ 클라이언트: 211.234.123.45:54321 (임시)      │
│            └──────────┬──────────┘           │
│                  Ephemeral Port              │
│                (OS가 자동 할당)              │
│                                              │
│ 서버:       10.0.1.10:80 (고정)              │
│            └──────────┘                      │
│             Well-known Port                  │
└──────────────────────────────────────────────┘

운영체제별 Ephemeral Port 범위:
• Linux: 32768-60999
• Windows Server: 49152-65535
• AWS NAT Gateway: 1024-65535

⚠️  NACL Outbound에서 이 범위를 열어야 응답 가능!
```

### NACL 규칙 예시

```nginx
# Public Subnet NACL
Inbound Rules:
┌──────┬──────┬──────────┬────────────┬─────────────┬────────┐
│ Rule#│ Type │ Protocol │ Port Range │ Source      │ Allow  │
├──────┼──────┼──────────┼────────────┼─────────────┼────────┤
│ 100  │ HTTP │ TCP      │ 80         │ 0.0.0.0/0   │ ALLOW  │
│ 110  │ HTTPS│ TCP      │ 443        │ 0.0.0.0/0   │ ALLOW  │
│ 120  │ SSH  │ TCP      │ 22         │ 1.2.3.4/32  │ ALLOW  │
│ 130  │ Custom│ TCP     │ 1024-65535 │ 0.0.0.0/0   │ ALLOW  │
│      │      │          │            │             │        │
│ *    │ All  │ All      │ All        │ 0.0.0.0/0   │ DENY   │
└──────┴──────┴──────────┴────────────┴─────────────┴────────┘
                                         ▲
                    Rule 130: Ephemeral Port 허용 (응답용)

Outbound Rules:
┌──────┬──────┬──────────┬────────────┬─────────────┬────────┐
│ Rule#│ Type │ Protocol │ Port Range │ Destination │ Allow  │
├──────┼──────┼──────────┼────────────┼─────────────┼────────┤
│ 100  │ HTTP │ TCP      │ 80         │ 0.0.0.0/0   │ ALLOW  │
│ 110  │ HTTPS│ TCP      │ 443        │ 0.0.0.0/0   │ ALLOW  │
│ 120  │ Custom│ TCP     │ 1024-65535 │ 0.0.0.0/0   │ ALLOW  │
│      │      │          │            │             │        │
│ *    │ All  │ All      │ All        │ 0.0.0.0/0   │ DENY   │
└──────┴──────┴──────────┴────────────┴─────────────┴────────┘
```

### NACL 규칙 평가 순서

```
예시: DDoS 공격 IP 차단

Inbound Rules:
┌──────┬────────┬─────────────┬────────┐
│ Rule#│ Source │ Destination │ Action │
├──────┼────────┼─────────────┼────────┤
│  50  │ 1.2.3.4│ All         │ DENY   │ ← 악성 IP
│ 100  │ 0.0.0.0│ 80          │ ALLOW  │
│ *    │ All    │ All         │ DENY   │
└──────┴────────┴─────────────┴────────┘

시나리오:
1️⃣ 1.2.3.4에서 접속 시도
   → Rule 50 매칭 → DENY ✅ (Rule 100 확인 안 함)

2️⃣ 5.6.7.8에서 접속 시도
   → Rule 50 매칭 안 됨
   → Rule 100 매칭 → ALLOW ✅

💡 낮은 번호 우선! 매칭되면 즉시 처리
   보통 10, 20, 30... 또는 100, 110, 120... 단위로 설정
   (중간에 규칙 추가할 여지 남김)
```

---

## Stateful vs Stateless의 진실

### 실제 패킷 흐름 비교

```
시나리오: 사용자(211.234.123.45)가 웹서버(10.0.1.10:80) 접속

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
보안그룹 (Stateful)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1️⃣ 요청 들어옴
   211.234.123.45:54321 → 10.0.1.10:80

   Inbound 규칙 확인:
   ✅ Port 80 허용됨 → 통과
   💾 연결 추적 테이블에 기록:
      "211.234.123.45:54321 ↔ 10.0.1.10:80 연결 허용"

2️⃣ 응답 나감
   10.0.1.10:80 → 211.234.123.45:54321

   Outbound 규칙 확인 안 함! ✅
   (연결 추적 테이블에 있으니 자동 허용)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
NACL (Stateless)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1️⃣ 요청 들어옴
   211.234.123.45:54321 → 10.0.1.10:80

   Inbound 규칙 확인:
   ✅ Rule 100: Port 80 허용 → 통과
   ❌ 연결 추적 안 함 (기록 안 남음)

2️⃣ 응답 나감
   10.0.1.10:80 → 211.234.123.45:54321

   Outbound 규칙 확인 필요! ⚠️
   ✅ Rule 120: Port 1024-65535 허용 → 통과
      (54321이 이 범위에 포함)

   만약 Rule 120이 없다면?
   ❌ 응답 차단됨 → 연결 실패!
```

### 왜 이렇게 설계되었나?

```
보안그룹 (Stateful) = 편의성
┌──────────────────────────────────────────────┐
│ • 인스턴스별 세밀한 제어                     │
│ • 연결 추적으로 사용 편리                    │
│ • 대부분의 보안은 여기서 처리                │
│ • 성능 오버헤드 있지만 인스턴스 레벨이라 OK  │
└──────────────────────────────────────────────┘

NACL (Stateless) = 성능 + 추가 보호
┌──────────────────────────────────────────────┐
│ • 서브넷 전체 보호 (광역 차단)               │
│ • 연결 추적 안 해서 성능 좋음                │
│ • DDoS, IP 블랙리스트 등에 활용              │
│ • 설정 복잡하지만 추가 보안 계층             │
└──────────────────────────────────────────────┘
```

---

## 보안그룹 vs NACL 완벽 비교표

| 특성            | Security Group        | NACL                                   |
| ------------- | --------------------- | -------------------------------------- |
| **적용 레벨**     | 인스턴스 (ENI)            | 서브넷                                    |
| **상태 추적**     | Stateful (추적함)        | Stateless (추적 안 함)                     |
| **규칙 타입**     | Allow만                | Allow + Deny                           |
| **규칙 평가**     | 모든 규칙 평가              | 번호 순서대로, 매칭 시 중단                       |
| **기본 정책**     | Deny All              | Default: Allow All<br>Custom: Deny All |
| **응답 처리**     | 자동 허용                 | 별도 규칙 필요                               |
| **규칙 개수**     | 인바운드 60개<br>아웃바운드 60개 | 인바운드 20개<br>아웃바운드 20개                  |
| **변경 적용**     | 즉시                    | 즉시                                     |
| **서브넷 내부 통신** | 검사함                   | 검사 안 함                                 |
|               |                       |                                        |

### 사용 시나리오

```
보안그룹 사용:
✅ 웹 서버 포트 제한 (80, 443만 허용)
✅ DB 접근 제어 (특정 보안그룹만 허용)
✅ 개발/스테이징/프로덕션 환경 분리
✅ SSH 접근 제한 (특정 IP만)

NACL 사용:
✅ 서브넷 전체에 IP 블랙리스트 적용
✅ DDoS 공격 IP 차단
✅ 특정 국가/지역 IP 차단
✅ 컴플라이언스 요구사항 (명시적 Deny 필요)

⚠️  대부분의 경우 보안그룹만으로 충분!
   NACL은 추가 보안 계층이 필요할 때만 사용
```

---

## 실전 시나리오와 설정

### 시나리오 1: 웹 애플리케이션 (3-Tier)

```
┌─────────────────────────────────────────────────────────────┐
│                      Public Subnet                          │
│                                                             │
│  NACL (기본 설정):                                          │
│  • In: All Allow (또는 80,443만)                            │
│  • Out: All Allow                                           │
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │ ALB                                                │     │
│  │ Security Group (sg-alb):                           │     │
│  │ • In: 80/0.0.0.0/0, 443/0.0.0.0/0                  │     │
│  │ • Out: All                                         │     │
│  └─────────────────────┬─────────────────────────────┘     │
│                        │                                    │
└────────────────────────┼────────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────────┐
│                      Private Subnet 1                       │
│                        │                                    │
│  NACL (기본 설정):     │                                    │
│  • In: All Allow       │                                    │
│  • Out: All Allow      │                                    │
│                        ▼                                    │
│  ┌───────────────────────────────────────────────────┐     │
│  │ Web Server (NestJS)                                │     │
│  │ Security Group (sg-web):                           │     │
│  │ • In: 8080/sg-alb (ALB로부터만!)                   │     │
│  │ • In: 22/sg-bastion (Bastion으로부터만!)           │     │
│  │ • Out: All                                         │     │
│  └─────────────────────┬─────────────────────────────┘     │
│                        │                                    │
└────────────────────────┼────────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────────┐
│                      Private Subnet 2                       │
│                        │                                    │
│  NACL (기본 설정):     │                                    │
│  • In: All Allow       │                                    │
│  • Out: All Allow      │                                    │
│                        ▼                                    │
│  ┌───────────────────────────────────────────────────┐     │
│  │ RDS (PostgreSQL)                                   │     │
│  │ Security Group (sg-db):                            │     │
│  │ • In: 5432/sg-web                                  │     │
│  │ • Out: None (필요 없음)                            │     │
│  └───────────────────────────────────────────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘

✅ 보안그룹만으로 충분한 보안!
   각 계층이 상위 계층만 접근 가능
```

### 시나리오 2: DDoS 공격 IP 차단 (NACL 활용)

```
상황: 특정 IP에서 DDoS 공격 감지
     211.234.123.100 ~ 211.234.123.200

Public Subnet NACL 설정:
┌──────┬────────────────────┬──────────┬────────┐
│ Rule#│ Source             │ Port     │ Action │
├──────┼────────────────────┼──────────┼────────┤
│  10  │ 211.234.123.100/32 │ All      │ DENY   │ ← 개별 차단
│  20  │ 211.234.123.0/24   │ All      │ DENY   │ ← 범위 차단
│ 100  │ 0.0.0.0/0          │ 80       │ ALLOW  │
│ 110  │ 0.0.0.0/0          │ 443      │ ALLOW  │
│ *    │ All                │ All      │ DENY   │
└──────┴────────────────────┴──────────┴────────┘

✅ 보안그룹으로는 DENY 불가능 → NACL 사용!
   공격 IP를 서브넷 레벨에서 차단
```

### 시나리오 3: Ephemeral Port 문제 해결

```
문제 상황:
웹 서버가 외부 API 호출 시 타임아웃

원인:
NACL Inbound에서 Ephemeral Port 미허용

┌────────────────────────────────────────────────┐
│ Web Server (10.0.1.10)                         │
│    │                                           │
│    │ 1️⃣ 외부 API 호출                          │
│    │    Src: 10.0.1.10:45678 (Ephemeral)      │
│    │    Dst: 52.X.X.X:443 (Slack API)         │
│    │                                           │
│    ▼                                           │
│ NACL Outbound: 443 허용 ✅                     │
│    │                                           │
└────┼───────────────────────────────────────────┘
     │
     ▼
 Internet (Slack API 응답)
     │
     ▼
┌────┼───────────────────────────────────────────┐
│    ▼                                           │
│ NACL Inbound 검사:                             │
│    Dst: 10.0.1.10:45678                        │
│    ▲                                           │
│    Ephemeral Port                              │
│                                                │
│ ❌ 1024-65535 허용 안 됨 → 차단됨!             │
│                                                │
│ 해결: Inbound에 1024-65535 추가               │
│ Rule 130: TCP 1024-65535 from 0.0.0.0/0 ALLOW │
└────────────────────────────────────────────────┘

💡 Stateless라서 응답도 Inbound 규칙 필요!
```

---

## 실습 가이드

### 1. 보안그룹 테스트

```bash
# EC2 인스턴스에 SSH 접속

# 1️⃣ 웹 서버 실행
python3 -m http.server 8080

# 2️⃣ 보안그룹에서 8080 포트 허용 전
# 외부에서 curl http://your-ip:8080
# → 타임아웃 (연결 안 됨)

# 3️⃣ 보안그룹 Inbound에 8080 추가
# AWS Console → Security Groups → Inbound Rules
# Type: Custom TCP, Port: 8080, Source: 0.0.0.0/0

# 4️⃣ 즉시 적용됨! (연결 끊김 없이)
# curl http://your-ip:8080
# → 성공! ✅
```

### 2. Stateful 동작 확인

```bash
# 보안그룹 설정:
# Inbound: 22 (SSH)
# Outbound: All Traffic (기본값)

# SSH 연결 후 외부 ping
ping 8.8.8.8
# ✅ 성공! (Outbound에 ICMP 명시 안 했는데도 가능)

# Outbound에서 All Traffic 제거
# → ICMP도 차단됨
ping 8.8.8.8
# ❌ 실패! (요청은 나가지만 응답이 못 들어옴)

# 하지만 SSH는 여전히 연결됨! ✅
# (이미 연결된 세션은 유지 - Stateful)
```

### 3. NACL Stateless 확인

```bash
# Custom NACL 생성 및 적용
# Inbound: 80 허용
# Outbound: 80 허용 (1024-65535 없음)

# 웹 서버 실행
python3 -m http.server 80

# 외부에서 curl
curl http://your-ip
# ❌ 타임아웃!

# 왜? Outbound에 Ephemeral Port 없음
# Outbound에 1024-65535 추가
# → 성공! ✅

💡 Stateless 특성 체감!
```

---

## 핵심 정리

### 🎯 5가지 핵심 원칙

```
1️⃣ 보안그룹 = 1차 방어선
   • 인스턴스 레벨, Stateful
   • 대부분의 보안은 여기서!

2️⃣ NACL = 추가 보안 계층
   • 서브넷 레벨, Stateless
   • IP 차단, 컴플라이언스용

3️⃣ Stateful = 편리함
   • 응답 자동 허용
   • Outbound는 기본 All로 충분

4️⃣ Stateless = Ephemeral Port 필수
   • 응답용 1024-65535 열어야 함
   • Inbound + Outbound 둘 다 설정

5️⃣ 보안그룹끼리 참조
   • IP 하드코딩 대신 sg-xxx 참조
   • Auto Scaling에 유리
```

### 🧠 이해도 자가 테스트

```
Q1: 웹 서버 보안그룹에 Inbound 80 허용. Outbound는?
A1: All Traffic (기본값) 그대로 두면 됨. Stateful이라 응답 자동 허용.

Q2: NACL에서 웹 서버(80) 허용하려면?
A2: Inbound 80 + Outbound 1024-65535 (Ephemeral Port) 둘 다 필요.

Q3: 특정 IP 차단하려면 보안그룹? NACL?
A3: NACL. 보안그룹은 Deny 규칙 없음.

Q4: RDS 보안그룹 Source를 IP 대신 sg-web으로 하는 이유는?
A4: Auto Scaling으로 웹 서버 IP가 바뀌어도 규칙 수정 불필요.

Q5: 서브넷 내부 EC2끼리 통신 시 NACL 검사하나?
A5: ❌ 안 함. 같은 서브넷 내부는 NACL 우회.
```

---

## 다음 단계

이제 보안 계층을 이해했으니:

1. **Elastic IP vs Public IP**: IP 주소 종류와 비용
2. **ALB + Target Group**: 로드밸런서와 Health Check
3. **VPC Endpoint**: S3/DynamoDB 접근 시 NAT 우회

다음 가이드에서 계속됩니다!

---

*마지막 업데이트: 2026-01-13*
