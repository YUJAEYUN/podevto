# AWS 라우팅 테이블 완벽 가이드

> IGW와 NAT Gateway 헷갈림을 해결하는 핵심 개념

## 목차
1. [왜 라우팅 테이블이 중요한가?](#왜-라우팅-테이블이-중요한가)
2. [라우팅 테이블 기본 개념](#라우팅-테이블-기본-개념)
3. [Public vs Private 서브넷의 진실](#public-vs-private-서브넷의-진실)
4. [패킷이 실제로 이동하는 경로](#패킷이-실제로-이동하는-경로)
5. [실습으로 이해하기](#실습으로-이해하기)

---

## 왜 라우팅 테이블이 중요한가?

### 당신이 했던 질문들

```
"공인IP만 있으면 인터넷 되는 거 아닌가?"
"IGW와 NAT Gateway 차이가 뭐야?"
"Public 서브넷에서 외부 API 호출할 때 IGW를 거쳐?"
"Private 서브넷의 DB가 Public 서브넷의 Nginx와 통신 가능해?"
```

이 모든 질문의 답은 **라우팅 테이블**에 있습니다.

### 핵심 개념

```
❌ 잘못된 이해:
"Public 서브넷 = 공인IP 있는 서브넷"
"Private 서브넷 = 공인IP 없는 서브넷"

✅ 정확한 이해:
"Public 서브넷 = 0.0.0.0/0 → IGW 라우트가 있는 서브넷"
"Private 서브넷 = 0.0.0.0/0 → IGW 라우트가 없는 서브넷"
```

**즉, 서브넷이 Public인지 Private인지는 "라우팅 테이블 설정"으로 결정됩니다!**

---

## 라우팅 테이블 기본 개념

### 라우팅 테이블이란?

```
라우팅 테이블 = "이 목적지로 가려면 어디로 보내야 하는지" 적어놓은 지도

일상 비유:
┌─────────────────────────────────────────┐
│ "서울 가려면? → 경부고속도로"           │
│ "부산 가려면? → 경부고속도로"           │
│ "우리 동네 편의점? → 그냥 걸어가"       │
└─────────────────────────────────────────┘

AWS 라우팅 테이블:
┌─────────────────────────────────────────┐
│ "10.0.0.0/16 가려면? → local (VPC 내부)" │
│ "0.0.0.0/0 (모든 인터넷) 가려면? → IGW" │
└─────────────────────────────────────────┘
```

### 라우팅 규칙 읽는 법

| Destination (목적지) | Target (경로) | 의미 |
|---------------------|---------------|------|
| `10.0.0.0/16` | `local` | VPC 내부 통신 (서브넷 간 통신) |
| `0.0.0.0/0` | `igw-xxxxx` | 모든 외부 인터넷 → Internet Gateway로 |
| `0.0.0.0/0` | `nat-xxxxx` | 모든 외부 인터넷 → NAT Gateway로 |
| `172.31.0.0/16` | `pcx-xxxxx` | 특정 VPC → VPC Peering으로 |

**중요**: 라우팅 테이블은 "가장 구체적인 규칙"부터 매칭합니다!

```
예시:
10.0.1.5로 가려면?
1. 10.0.0.0/16 → local (매칭됨! ✅)
2. 0.0.0.0/0 → igw (확인할 필요 없음)

8.8.8.8(구글 DNS)로 가려면?
1. 10.0.0.0/16 → local (매칭 안 됨)
2. 0.0.0.0/0 → igw (매칭됨! ✅)
```

---

## Public vs Private 서브넷의 진실

### AWS 공식 정의

```
Public Subnet:
라우팅 테이블에 "0.0.0.0/0 → Internet Gateway" 라우트가 있는 서브넷

Private Subnet:
라우팅 테이블에 "0.0.0.0/0 → Internet Gateway" 라우트가 없는 서브넷
```

### 실제 VPC 구성 예시

```
VPC: 10.0.0.0/16
├─ Public Subnet: 10.0.1.0/24
│  └─ 라우팅 테이블 (rtb-public)
│     ├─ 10.0.0.0/16 → local
│     └─ 0.0.0.0/0 → igw-1234 ✅ (인터넷 직접 연결)
│
└─ Private Subnet: 10.0.2.0/24
   └─ 라우팅 테이블 (rtb-private)
      ├─ 10.0.0.0/16 → local
      └─ 0.0.0.0/0 → nat-5678 ❌ (NAT 통해서만 가능)
          (또는 이 라우트 자체가 없을 수도 있음)
```

### 각 구성요소 연결 방식

```
┌────────────────────────────────────────────────────────────────┐
│                    VPC (10.0.0.0/16)                           │
│                                                                │
│  ┌──────────────────────────┐  ┌──────────────────────────┐   │
│  │ Public Subnet            │  │ Private Subnet           │   │
│  │ 10.0.1.0/24              │  │ 10.0.2.0/24              │   │
│  │                          │  │                          │   │
│  │ ┌──────────────────┐     │  │ ┌──────────────────┐     │   │
│  │ │ EC2 (Nginx)      │     │  │ │ RDS (PostgreSQL) │     │   │
│  │ │ Private: 10.0.1.10│    │  │ │ Private: 10.0.2.20│    │   │
│  │ │ Public: 3.35.X.X │     │  │ │ (공인IP 없음)     │     │   │
│  │ └──────────────────┘     │  │ └──────────────────┘     │   │
│  │                          │  │                          │   │
│  │ Route Table: rtb-public  │  │ Route Table: rtb-private │   │
│  │ • 10.0.0.0/16 → local ✅ │  │ • 10.0.0.0/16 → local ✅ │   │
│  │ • 0.0.0.0/0 → IGW     ✅ │  │ • 0.0.0.0/0 → NAT GW  ⚠️ │   │
│  └──────────┬───────────────┘  └────────────┬─────────────┘   │
│             │                               │                 │
│             │ (IGW로 나감)                  │ (NAT로 나감)    │
└─────────────┼───────────────────────────────┼─────────────────┘
              │                               │
              ▼                               ▼
     ┌─────────────────┐            ┌─────────────────┐
     │ Internet Gateway│            │  NAT Gateway    │
     │  (igw-1234)     │            │  (nat-5678)     │
     │                 │            │ Public Subnet 안에 위치!
     └────────┬────────┘            └────────┬────────┘
              │                              │
              └──────────────┬───────────────┘
                             ▼
                      ┌─────────────┐
                      │   Internet  │
                      └─────────────┘
```

---

## 패킷이 실제로 이동하는 경로

### 시나리오 1: 사용자가 Nginx 서버에 접속

```
사용자 (211.234.123.45) → https://myapp.com 접속

1️⃣ 사용자 → Internet → Internet Gateway
   ┌────────────────────────────────────────────┐
   │ 출발지: 211.234.123.45                     │
   │ 목적지: 3.35.X.X (Nginx 공인IP)            │
   └────────────────────────────────────────────┘

2️⃣ Internet Gateway → Public Subnet (Nginx)
   ┌────────────────────────────────────────────┐
   │ IGW가 자동으로 주소 변환:                   │
   │ 3.35.X.X (공인IP) → 10.0.1.10 (사설IP)     │
   └────────────────────────────────────────────┘

3️⃣ Nginx에 패킷 도착
   ┌────────────────────────────────────────────┐
   │ Nginx가 받은 패킷:                         │
   │ 출발지: 211.234.123.45                     │
   │ 목적지: 10.0.1.10 (자기 자신)              │
   └────────────────────────────────────────────┘

✅ 핵심: Internet Gateway가 공인IP ↔ 사설IP 자동 변환!
```

### 시나리오 2: Nginx가 Private Subnet의 RDS에 접속

```
Nginx (10.0.1.10) → RDS (10.0.2.20) 연결

1️⃣ Nginx에서 RDS로 패킷 전송
   ┌────────────────────────────────────────────┐
   │ 출발지: 10.0.1.10 (Nginx)                  │
   │ 목적지: 10.0.2.20 (RDS)                    │
   └────────────────────────────────────────────┘

2️⃣ 라우팅 테이블 확인
   ┌────────────────────────────────────────────┐
   │ rtb-public 규칙 확인:                      │
   │ • 10.0.0.0/16 → local (매칭! ✅)           │
   │   → VPC 내부 통신이니까 그냥 직접 전달    │
   └────────────────────────────────────────────┘

3️⃣ RDS에 패킷 도착
   ┌────────────────────────────────────────────┐
   │ IGW나 NAT를 거치지 않음!                   │
   │ VPC 내부에서 직접 통신                     │
   └────────────────────────────────────────────┘

✅ 핵심: 같은 VPC 내 서브넷끼리는 "local" 라우트로 직접 통신!
   Public/Private 구분 상관없음!
```

### 시나리오 3: Nginx가 외부 API 호출 (예: Slack)

```
Nginx (10.0.1.10) → api.slack.com (52.X.X.X) 호출

1️⃣ Nginx에서 외부로 패킷 전송
   ┌────────────────────────────────────────────┐
   │ 출발지: 10.0.1.10 (Nginx)                  │
   │ 목적지: 52.X.X.X (Slack)                   │
   └────────────────────────────────────────────┘

2️⃣ 라우팅 테이블 확인
   ┌────────────────────────────────────────────┐
   │ rtb-public 규칙 확인:                      │
   │ • 10.0.0.0/16 → local (매칭 안 됨)         │
   │ • 0.0.0.0/0 → igw-1234 (매칭! ✅)          │
   └────────────────────────────────────────────┘

3️⃣ Internet Gateway로 전송
   ┌────────────────────────────────────────────┐
   │ IGW가 자동으로 주소 변환:                   │
   │ 10.0.1.10 (사설IP) → 3.35.X.X (공인IP)     │
   │ 그리고 인터넷으로 전송                      │
   └────────────────────────────────────────────┘

✅ 핵심: Public Subnet은 IGW를 통해 직접 인터넷 접속!
```

### 시나리오 4: RDS가 외부 API 호출 (예: S3 업로드)

```
RDS (10.0.2.20) → s3.amazonaws.com 호출 시도

⚠️ 문제 상황: RDS는 공인IP가 없음!

1️⃣ RDS에서 외부로 패킷 전송
   ┌────────────────────────────────────────────┐
   │ 출발지: 10.0.2.20 (RDS, 사설IP만 있음)     │
   │ 목적지: 52.X.X.X (S3)                      │
   └────────────────────────────────────────────┘

2️⃣ 라우팅 테이블 확인
   ┌────────────────────────────────────────────┐
   │ rtb-private 규칙 확인:                     │
   │ • 10.0.0.0/16 → local (매칭 안 됨)         │
   │ • 0.0.0.0/0 → nat-5678 (매칭! ✅)          │
   └────────────────────────────────────────────┘

3️⃣ NAT Gateway로 전송
   ┌────────────────────────────────────────────┐
   │ NAT Gateway는 Public Subnet에 위치        │
   │ NAT가 주소 변환:                           │
   │ 10.0.2.20 (RDS 사설IP)                     │
   │   → NAT의 공인IP (예: 13.X.X.X)            │
   └────────────────────────────────────────────┘

4️⃣ NAT Gateway → Internet Gateway → 인터넷
   ┌────────────────────────────────────────────┐
   │ NAT Gateway의 라우팅 테이블(rtb-public):   │
   │ • 0.0.0.0/0 → igw-1234                     │
   │ → IGW를 통해 인터넷으로 나감               │
   └────────────────────────────────────────────┘

✅ 핵심: Private Subnet은 NAT Gateway를 통해서만 인터넷 접속!
   NAT Gateway는 반드시 Public Subnet에 위치해야 함!
```

---

## IGW vs NAT Gateway 완벽 비교

### 근본적인 차이

```
┌──────────────────────────────────────────────────────────────┐
│                    Internet Gateway (IGW)                    │
├──────────────────────────────────────────────────────────────┤
│ • VPC 전체에 1개 연결                                         │
│ • 양방향 통신 (외부 → 내부, 내부 → 외부 모두 가능)            │
│ • 공인IP가 있는 리소스만 사용 가능                            │
│ • 비용 무료 (데이터 전송 비용만)                              │
│ • 1:1 주소 변환 (공인IP ↔ 사설IP)                            │
│                                                              │
│   예시: 3.35.X.X ↔ 10.0.1.10                                │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                    NAT Gateway                                │
├──────────────────────────────────────────────────────────────┤
│ • Public Subnet에 위치 (가용영역당 1개 권장)                  │
│ • 단방향 통신 (내부 → 외부만 가능, 외부에서 접근 불가)        │
│ • 공인IP 없는 리소스가 인터넷 접속할 때 사용                  │
│ • 시간당 비용 + 데이터 전송 비용 ($$$)                        │
│ • N:1 주소 변환 (여러 사설IP → NAT의 공인IP 1개)             │
│                                                              │
│   예시: 10.0.2.10, 10.0.2.20, 10.0.2.30                      │
│         → 모두 13.X.X.X (NAT IP)로 변환                      │
└──────────────────────────────────────────────────────────────┘
```

### 언제 무엇을 사용하나?

| 상황 | 사용 | 이유 |
|------|------|------|
| 사용자가 웹서버 접속 | IGW | 외부에서 내부로 들어와야 함 |
| 웹서버가 외부 API 호출 | IGW | 공인IP 있으면 직접 나감 |
| DB가 외부 API 호출 | NAT | 공인IP 없고, 외부 접근 차단 필요 |
| Lambda가 RDS 접속하면서 외부 API도 호출 | NAT | Lambda를 Private Subnet에 배치 |

### 실전 질문 답변

```
Q: "공인IP만 있으면 인터넷 되는 거 아닌가?"
A: 공인IP + IGW로 가는 라우트 둘 다 필요!
   공인IP만 있고 라우트 없으면 통신 불가.

Q: "IGW 있으면 NAT 필요 없지 않아?"
A: Private Subnet 리소스는 공인IP가 없어서 IGW 못 씀.
   NAT를 통해 "NAT의 공인IP"를 빌려서 나가는 것.

Q: "Public Subnet에서 외부 API 호출할 때 IGW 거쳐?"
A: YES! 라우팅 테이블의 0.0.0.0/0 → IGW 규칙 적용됨.

Q: "Private DB가 Public Nginx와 통신 가능해?"
A: YES! 10.0.0.0/16 → local 규칙으로 VPC 내부 직접 통신.
   IGW/NAT 안 거침.
```

---

## 실습으로 이해하기

### 1. AWS Console에서 라우팅 테이블 확인

```bash
# AWS Console
1. VPC 서비스 이동
2. 왼쪽 메뉴에서 "Route Tables" 클릭
3. 각 라우팅 테이블 선택 후 "Routes" 탭 확인

예시 출력:
┌──────────────────┬──────────────┬────────┐
│ Destination      │ Target       │ Status │
├──────────────────┼──────────────┼────────┤
│ 10.0.0.0/16      │ local        │ active │
│ 0.0.0.0/0        │ igw-0abcd123 │ active │
└──────────────────┴──────────────┴────────┘
```

### 2. EC2 인스턴스 내부에서 라우팅 확인

```bash
# EC2에 SSH 접속 후
ip route

# 출력 예시:
default via 10.0.1.1 dev eth0
10.0.1.0/24 dev eth0 proto kernel scope link src 10.0.1.10

# 해석:
# - default (0.0.0.0/0): 기본 게이트웨이 10.0.1.1로 전송
#   (이게 VPC의 가상 라우터)
# - 10.0.1.0/24: 같은 서브넷은 직접 통신
```

### 3. 패킷 추적 실습

```bash
# Public Subnet EC2에서
# 1. VPC 내부 통신 (Private Subnet RDS)
traceroute 10.0.2.20
# 출력: 1 hop만 나옴 (직접 통신)

# 2. 외부 통신 (구글)
traceroute 8.8.8.8
# 출력:
# 1  10.0.1.1 (VPC 라우터)
# 2  ??? (IGW, 내부에서 안 보임)
# 3  X.X.X.X (ISP)
# ...

# Private Subnet에 NAT 있으면
traceroute 8.8.8.8
# 출력:
# 1  10.0.2.1 (VPC 라우터)
# 2  10.0.1.X (NAT Gateway의 사설IP)
# 3  ??? (IGW)
# 4  X.X.X.X (ISP)
```

### 4. 라우팅 테이블 직접 수정 실습

```bash
# Public Subnet을 Private으로 바꾸기
# AWS Console에서:
1. 라우팅 테이블에서 "0.0.0.0/0 → IGW" 라우트 삭제
2. EC2에서 curl https://google.com 시도
   → 실패! (Time out)

3. "0.0.0.0/0 → NAT Gateway" 라우트 추가
4. 다시 curl 시도
   → 성공! (하지만 외부에서 접근은 불가)

✅ 서브넷의 Public/Private는 라우팅 테이블이 결정함을 확인!
```

---

## 핵심 정리

### 🎯 5가지 핵심 원칙

```
1️⃣ 서브넷 구분 = 라우팅 테이블 설정
   - Public: 0.0.0.0/0 → IGW 있음
   - Private: 0.0.0.0/0 → IGW 없음 (또는 NAT로)

2️⃣ VPC 내부 통신 = local 라우트
   - 10.0.0.0/16 → local
   - Public/Private 관계없이 직접 통신

3️⃣ Internet Gateway = 양방향 + 1:1 변환
   - 외부 → 내부, 내부 → 외부 모두 가능
   - 공인IP 필수

4️⃣ NAT Gateway = 단방향 + N:1 변환
   - 내부 → 외부만 (외부에서 접근 불가)
   - Private Subnet이 인터넷 쓸 때
   - 비용 주의! ($45/월 + 데이터 전송비)

5️⃣ 패킷 흐름 = 라우팅 테이블 따라감
   - 목적지 IP 보고 → 테이블 매칭 → Target으로 전송
```

### 🧠 이해도 자가 테스트

```
Q1: 10.0.1.10(Public)에서 10.0.2.20(Private)로 통신할 때 IGW를 거치나?
A1: ❌ 안 거침. 10.0.0.0/16 → local 규칙으로 직접 통신.

Q2: 10.0.2.20(Private, 공인IP 없음)이 외부 API 호출하려면?
A2: NAT Gateway 필요. 0.0.0.0/0 → nat-xxxx 라우트 설정.

Q3: NAT Gateway는 어느 서브넷에 위치해야 하나?
A3: Public Subnet. NAT 자신도 인터넷 접속해야 하니까 IGW 필요.

Q4: 공인IP 있는 EC2를 Private Subnet에 넣으면?
A4: 라우팅 테이블에 IGW 라우트 없으면 인터넷 안 됨.
    공인IP는 있지만 "나가는 길"이 없는 것.

Q5: Default VPC가 바로 인터넷 되는 이유는?
A5: 자동으로 IGW가 연결되고, 라우팅 테이블에 0.0.0.0/0 → IGW가 설정되어 있어서.
```

---

## 다음 단계

이제 라우팅 테이블을 이해했으니:

1. **보안그룹 vs NACL**: 라우팅 테이블이 "경로"라면, 보안그룹/NACL은 "검문소"
2. **VPC Endpoint**: NAT 없이 AWS 서비스 접근 (비용 절감!)
3. **ALB + Target Group**: 로드밸런서도 결국 라우팅의 일종

다음 가이드에서 계속됩니다!

---

*마지막 업데이트: 2026-01-13*
